function dragElement(e){var t={x:0,y:0},n={x:0,y:0};e.onmousedown=function(o){o=o||window.event,n.x=o.clientX,n.y=o.clientY,document.onmouseup=function(){document.onmouseup=null,document.onmousemove=null},document.onmousemove=function(o){o=o||window.event,t.x=n.x-o.clientX,t.y=n.y-o.clientY,n.x=o.clientX,n.y=o.clientY,e.style.top=e.offsetTop-t.y+"px",e.style.left=e.offsetLeft-t.x+"px";var i=document.getElementById("project"),l=document.getElementById("main-svg");i.scrollHeight==i.offsetHeight&&i.scrollWidth==i.offsetWidth||(l.setAttribute("viewbox","0 0 "+i.scrollWidth+" "+i.scrollHeight),l.setAttribute("style","width: "+i.scrollWidth+"px; height: "+i.scrollHeight+"px;"));for(var a=e.getAttribute("data-id"),d=document.querySelectorAll('line[link*="'+a+'"]'),r=0;r<d.length;r++){var u=d[r],s=JSON.parse(u.getAttribute("link"));if(s.start==a||s.end==a){var f=s.start==a?s.end:s.start,c=document.querySelector(".dialogue[data-id='"+f+"']"),g=getDimensionDiff(c,e);updateLine(g,c,e,u)}}}}}function setLinks(e){var t=e.querySelector(".entry-point");e.querySelector(".next-point").onclick=function(){var t=e.getAttribute("data-id");t&&(currentID=t)},t.onclick=function(t){var n=e.getAttribute("data-id");if(currentID&&dialogues[currentID].nextDialogue.indexOf(parseInt(n))<0){dialogues[currentID].addNextDialogue(parseInt(n));var o=document.querySelector(".dialogue[data-id='"+currentID+"']");createLine(getDimensionDiff(o,e),o,e),currentID=null}}}function createLine(e,t,n){var o=document.getElementById("main-svg"),i=t.offsetTop<n.offsetTop?makeSVG("line",{x1:e.left,y1:e.top,x2:e.width+e.left,y2:e.height+e.top,"stroke-width":"2",stroke:"black",style:"marker-end: url(#arrowhead);",link:JSON.stringify({start:t.getAttribute("data-id"),end:n.getAttribute("data-id")})}):makeSVG("line",{x1:e.left,y2:e.top,x2:e.width+e.left,y1:e.height+e.top,"stroke-width":"2",stroke:"black",style:"marker-end: url(#arrowhead);",link:JSON.stringify({start:t.getAttribute("data-id"),end:n.getAttribute("data-id")})});o.appendChild(i)}function getDimensionDiff(e,t){var n=Math.min(e.offsetTop,t.offsetTop),o=Math.max(e.offsetTop,t.offsetTop),i=Math.min(e.offsetLeft,t.offsetLeft),l=Math.max(e.offsetLeft,t.offsetLeft);return{top:n==e.offsetTop?n+e.offsetHeight/2:n+t.offsetHeight/2,left:i==e.offsetLeft?i+e.offsetWidth:i+t.offsetWidth,width:i==e.offsetLeft?l-i-e.offsetWidth:l-i-t.offsetWidth,height:n==e.offsetTop?o-n-e.offsetHeight/2+t.offsetHeight/2:o-n-t.offsetHeight/2+e.offsetHeight/2}}function exportData(e,t){var n=document.getElementById("export-dialogues"),o=document.getElementById("export-link");o.setAttribute("download",e+".json"),o.setAttribute("href","data:application/json,"+encodeURIComponent(JSON.stringify(t))),o.setAttribute("target","_blank"),o.onclick=function(){n.classList.toggle("show")}}var currentID,Dialogue=function(){function e(e,t,n){this.nextDialogue=[],this.id=e,this.text=t,this.actor=n||"npc"}return e.prototype.addNextDialogue=function(e){this.nextDialogue.push(e)},e}(),dialogueHTML=function(e){var t=document.createElement("div");return t.classList.add("dialogue"),t.setAttribute("data-id",""+e.id),t.innerHTML='<div class="entry-point"></div>\n    <div class="next-point"></div>\n    <div class="actor">'+e.actor+'</div>\n    <div class="text">'+e.text+"</div>",t},dialogues=[],makeSVG=function(e,t){var n=document.createElementNS("http://www.w3.org/2000/svg",e);for(var o in t)n.setAttribute(o,t[o]);return n},updateLine=function(e,t,n,o){var i={},l=(e.width,e.height,e.top,e.left,e.width,e.height,"");l=JSON.parse(o.getAttribute("link")).start==t.getAttribute("data-id")?t.offsetLeft<n.offsetLeft?"marker-end: url(#arrowhead); marker-start: none;":"marker-start: url(#endarrow); marker-end: none;":t.offsetLeft>n.offsetLeft?"marker-end: url(#arrowhead); marker-start: none;":"marker-start: url(#endarrow); marker-end: none;",(i=t.offsetTop<n.offsetTop?t.offsetLeft<n.offsetLeft?{x1:e.left,y1:e.top,x2:e.width+e.left,y2:e.height+e.top}:{x1:e.left,y1:e.height+e.top,y2:e.top,x2:e.width+e.left}:t.offsetLeft<n.offsetLeft?{x1:e.left,y1:e.height+e.top,y2:e.top,x2:e.width+e.left}:{x1:e.left,y1:e.top,x2:e.width+e.left,y2:e.height+e.top}).style=l;for(var a in i)o.setAttribute(a,i[a])};document.addEventListener("DOMContentLoaded",function(){var e=0,t=document.getElementById("project"),n=document.getElementById("create-dialogue"),o=document.getElementById("export-dialogues");document.getElementById("add-dialogue").addEventListener("click",function(){var o=document.getElementById("dialogText"),i=document.getElementById("dialogActor");if(null!=o.value&&""!=o.value){var l=new Dialogue(e++,o.value,i.value);dialogues.push(l);var a=dialogueHTML(l);a.style.top="10px",a.style.left="10px",dragElement(a),setLinks(a),t.appendChild(a),o.value="",i.value="",n.classList.toggle("show")}}),document.getElementById("cancel-dialogue").addEventListener("click",function(){var e=document.getElementById("dialogText"),t=document.getElementById("dialogActor");e.value="",t.value="",n.classList.toggle("show")}),document.getElementById("add-dialog").addEventListener("click",function(){n.classList.toggle("show")}),document.getElementById("export-file").addEventListener("click",function(){exportData(document.getElementById("file-title").innerText,dialogues),o.classList.toggle("show")}),document.getElementById("cancel-export").addEventListener("click",function(){o.classList.toggle("show")}),document.getElementById("file-title").addEventListener("dblclick",function(){var e=document.getElementById("file-title");e.style.display="none";var t=document.createElement("input");t.id="input-file-title",t.value=e.innerText,e.parentNode.appendChild(t),document.onclick=function(n){"input-file-title"!=(n.target||n.srcElement).id&&(e.innerText=t.value,e.style.display="block",t.parentNode.removeChild(t),document.onclick=null,document.onkeyup=null)},document.onkeyup=function(n){13!=n.keyCode&&27!=n.keyCode||(e.innerText=t.value,e.style.display="block",t.parentNode.removeChild(t),document.onclick=null,document.onkeyup=null)}});var i=document.getElementById("file-input");i.addEventListener("change",function(){var n=i.files;if(1===n.length){var o=n[0],l=new FileReader;l.onload=function(n){if(""!=l.result){var o=JSON.parse(l.result);if(0!=o.length){for(var i=0;i<o.length;i++){var a=o[i],d=new Dialogue(a.id,a.text,a.actor);d.nextDialogue=a.nextDialogue,dialogues.push(d);var r=dialogueHTML(d);r.style.top="10px",r.style.left="10px",dragElement(r),setLinks(r),t.appendChild(r)}dialogues.forEach(function(e){0!=e.nextDialogue.length&&e.nextDialogue.forEach(function(t){var n=document.querySelector(".dialogue[data-id='"+e.id+"']"),o=document.querySelector(".dialogue[data-id='"+t+"']");createLine(getDimensionDiff(n,o),n,o)})}),e=o.length}}},l.readAsBinaryString(o.slice())}})});