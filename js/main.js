function dragElement(e){var t={x:0,y:0},n={x:0,y:0};e.onmousedown=function(i){i=i||window.event,n.x=i.clientX,n.y=i.clientY,document.onmouseup=function(){document.onmouseup=null,document.onmousemove=null},document.onmousemove=function(i){i=i||window.event,t.x=n.x-i.clientX,t.y=n.y-i.clientY,n.x=i.clientX,n.y=i.clientY,e.style.top=e.offsetTop-t.y+"px",e.style.left=e.offsetLeft-t.x+"px";for(var o=e.getAttribute("data-id"),a=document.querySelectorAll('svg[link*="'+o+'"]'),d=0;d<a.length;d++){var r=a[d],l=JSON.parse(r.getAttribute("link"));if(l.start==o||l.end==o){var u=l.start==o?l.end:l.start,s=document.querySelector(".dialogue[data-id='"+u+"']"),f=getDimensionDiff(s,e);updateLine(f,s,e,r)}}}}}function setLinks(e){var t=e.querySelector(".entry-point");e.querySelector(".next-point").onclick=function(){var t=e.getAttribute("data-id");t&&(currentID=t)},t.onclick=function(t){var n=e.getAttribute("data-id");if(currentID&&dialogues[currentID].nextDialogue.indexOf(parseInt(n))<0){dialogues[currentID].addNextDialogue(parseInt(n));var i=document.querySelector(".dialogue[data-id='"+currentID+"']"),o=createLine(getDimensionDiff(i,e),i,e);document.getElementById("project").appendChild(o),currentID=null}}}function createLine(e,t,n){e={top:e.top,left:e.left,height:e.height<=12?12:e.height,width:e.width<=12?12:e.width};var i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("viewbox","0 0 "+e.height+" "+e.width),i.setAttribute("style","position: absolute; top: "+e.top+"; left: "+e.left+"; width: "+e.width+"px; height: "+e.height+"px;"),i.setAttribute("link",JSON.stringify({start:t.getAttribute("data-id"),end:n.getAttribute("data-id")}));var o=makeSVG("defs",{}),a=makeSVG("marker",{id:"arrowhead",markerWidth:"12",markerHeight:"12",refX:"12",refY:"6",orient:"auto"}),d=makeSVG("path",{d:"M0,0 L0,12 L12,6 L0,0",style:"fill: #000000;"});a.appendChild(d),o.appendChild(a);var r=makeSVG("marker",{id:"endarrow",markerWidth:"12",markerHeight:"12",refX:"0",refY:"6",orient:"auto"}),l=makeSVG("path",{d:"M12,12 L12,0 L0,6 L12,12",style:"fill: #000000;"});r.appendChild(l),o.appendChild(r);var u=t.offsetTop<n.offsetTop?makeSVG("line",{x1:"0",y1:"0",x2:e.width,y2:e.height,"stroke-width":"2",stroke:"black",style:"marker-end: url(#arrowhead);"}):makeSVG("line",{x1:"0",y2:"0",x2:e.width,y1:e.height,"stroke-width":"2",stroke:"black",style:"marker-end: url(#arrowhead);"});return i.appendChild(o),i.appendChild(u),i}function getDimensionDiff(e,t){var n=Math.min(e.offsetTop,t.offsetTop),i=Math.max(e.offsetTop,t.offsetTop),o=Math.min(e.offsetLeft,t.offsetLeft),a=Math.max(e.offsetLeft,t.offsetLeft);return{top:n==e.offsetTop?n+e.offsetHeight/2:n+t.offsetHeight/2,left:o==e.offsetLeft?o+e.offsetWidth:o+t.offsetWidth,width:o==e.offsetLeft?a-o-e.offsetWidth:a-o-t.offsetWidth,height:n==e.offsetTop?i-n-e.offsetHeight/2+t.offsetHeight/2:i-n-t.offsetHeight/2+e.offsetHeight/2}}function exportData(e,t){var n=document.getElementById("export-dialogues"),i=document.getElementById("export-link");i.setAttribute("download",e+".json"),i.setAttribute("href","data:application/json,"+encodeURIComponent(JSON.stringify(t))),i.setAttribute("target","_blank"),i.onclick=function(){n.classList.toggle("show")}}var currentID,Dialogue=function(){function e(e,t,n){this.nextDialogue=[],this.id=e,this.text=t,this.actor=n||"npc"}return e.prototype.addNextDialogue=function(e){this.nextDialogue.push(e)},e}(),dialogueHTML=function(e){var t=document.createElement("div");return t.classList.add("dialogue"),t.setAttribute("data-id",""+e.id),t.innerHTML='<div class="entry-point"></div>\n    <div class="next-point"></div>\n    <div class="actor">'+e.actor+'</div>\n    <div class="text">'+e.text+"</div>",t},dialogues=[],makeSVG=function(e,t){var n=document.createElementNS("http://www.w3.org/2000/svg",e);for(var i in t)n.setAttribute(i,t[i]);return n},updateLine=function(e,t,n,i){e={top:e.top,left:e.left,height:e.height<=12?12:e.height,width:e.width<=12?12:e.width};var o=i.querySelector("line"),a={},d={viewbox:"0 0 "+e.width+" "+e.height,style:"position: absolute; top: "+e.top+"px; left: "+e.left+"px; width: "+e.width+"px; height: "+e.height+"px;"},r="";r=JSON.parse(i.getAttribute("link")).start==t.getAttribute("data-id")?t.offsetLeft<n.offsetLeft?"marker-end: url(#arrowhead); marker-start: none;":"marker-start: url(#endarrow); marker-end: none;":t.offsetLeft>n.offsetLeft?"marker-end: url(#arrowhead); marker-start: none;":"marker-start: url(#endarrow); marker-end: none;",(a=t.offsetTop<n.offsetTop?t.offsetLeft<n.offsetLeft?{x1:"0",y1:"0",x2:e.width,y2:e.height}:{x1:"0",y1:e.height,y2:"0",x2:e.width}:t.offsetLeft<n.offsetLeft?{x1:"0",y1:e.height,y2:"0",x2:e.width}:{x1:"0",y1:"0",x2:e.width,y2:e.height}).style=r;for(var l in a)o.setAttribute(l,a[l]);for(var l in d)i.setAttribute(l,d[l])};document.addEventListener("DOMContentLoaded",function(){var e=0,t=document.getElementById("project"),n=document.getElementById("create-dialogue"),i=document.getElementById("export-dialogues");document.getElementById("add-dialogue").addEventListener("click",function(){var i=document.getElementById("dialogText"),o=document.getElementById("dialogActor");if(null!=i.value&&""!=i.value){var a=new Dialogue(e++,i.value,o.value);dialogues.push(a);var d=dialogueHTML(a);d.style.top="10px",d.style.left="10px",dragElement(d),setLinks(d),t.appendChild(d),i.value="",o.value="",n.classList.toggle("show")}}),document.getElementById("cancel-dialogue").addEventListener("click",function(){var e=document.getElementById("dialogText"),t=document.getElementById("dialogActor");e.value="",t.value="",n.classList.toggle("show")}),document.getElementById("add-dialog").addEventListener("click",function(){n.classList.toggle("show")}),document.getElementById("export-file").addEventListener("click",function(){exportData(document.getElementById("file-title").innerText,dialogues),i.classList.toggle("show")}),document.getElementById("cancel-export").addEventListener("click",function(){i.classList.toggle("show")}),document.getElementById("file-title").addEventListener("dblclick",function(){var e=document.getElementById("file-title");e.style.display="none";var t=document.createElement("input");t.id="input-file-title",t.value=e.innerText,e.parentNode.appendChild(t),document.onclick=function(n){"input-file-title"!=(n.target||n.srcElement).id&&(e.innerText=t.value,e.style.display="block",t.parentNode.removeChild(t),document.onclick=null,document.onkeyup=null)},document.onkeyup=function(n){13!=n.keyCode&&27!=n.keyCode||(e.innerText=t.value,e.style.display="block",t.parentNode.removeChild(t),document.onclick=null,document.onkeyup=null)}});var o=document.getElementById("file-input");o.addEventListener("change",function(){var n=o.files;if(1===n.length){var i=n[0],a=new FileReader;a.onload=function(n){if(""!=a.result){var i=JSON.parse(a.result);if(0!=i.length){for(var o=0;o<i.length;o++){var d=i[o],r=new Dialogue(d.id,d.text,d.actor);r.nextDialogue=d.nextDialogue,dialogues.push(r);var l=dialogueHTML(r);l.style.top="10px",l.style.left="10px",dragElement(l),setLinks(l),t.appendChild(l)}dialogues.forEach(function(e){0!=e.nextDialogue.length&&e.nextDialogue.forEach(function(t){var n=document.querySelector(".dialogue[data-id='"+e.id+"']"),i=document.querySelector(".dialogue[data-id='"+t+"']"),o=createLine(getDimensionDiff(n,i),n,i);document.getElementById("project").appendChild(o)})}),e=i.length}}},a.readAsBinaryString(i.slice())}})});